name: CI Build & Push Images

on:
  push:
    branches: [main]
    paths:
      - src/**
      - Dockerfile
      - pyproject.toml
      - uv.lock
      - .github/workflows/ci-docker-build-push.yaml

jobs:
  build-image:
    name: ðŸš€ Build Image
    uses: opencloudhub/.github/.github/workflows/shared-ci-docker-build-push.yaml@main
    with:
      repo-name: "demo-app-genai-backend"
      context: "."
      dockerfile: "Dockerfile"
      target: "prod"
      push-on-pr: true
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}


# name: CI Build & Push Images

# on:
#   push:
#     branches: [main]
#     paths:
#       - src/**
#       - Dockerfile
#       - pyproject.toml
#       - uv.lock
#       - .github/workflows/ci-docker-build-push.yaml

# jobs:
#   # Job 1: Build and push SERVING image
#   build-serving:
#     name: ðŸš€ Build Serving Image
#     runs-on: self-hosted-local
#     steps:
#       - name: ðŸ§¹ Cleanup
#         run: |
#           docker buildx prune -f --keep-storage 5GB || true

#       - name: ðŸ“¥ Checkout
#         uses: actions/checkout@v4

#       - name: ðŸ³ Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: ðŸ” Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_TOKEN }}

#       - name: ðŸ·ï¸ Extract metadata
#         id: meta
#         run: |
#           SHA=${GITHUB_SHA::7}
#           echo "tag_prefix=main-${SHA}" >> $GITHUB_OUTPUT
#           echo "sha=${SHA}" >> $GITHUB_OUTPUT

#       - name: ðŸ“¦ Build and push serving image
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: ./Dockerfile
#           target: serving
#           push: true
#           provenance: false
#           tags: |
#             ${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:${{ steps.meta.outputs.tag_prefix }}
#             ${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:latest
#           cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:buildcache-serving
#           cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:buildcache-serving,mode=max

#   # Job 2: Build and push EVALUATION image (runs after serving)
#   build-evaluation:
#     name: ðŸ§ª Build Evaluation Image
#     runs-on: self-hosted-local
#     needs: build-serving
#     steps:
#       - name: ðŸ§¹ Cleanup
#         run: |
#           docker buildx prune -f --keep-storage 5GB || true

#       - name: ðŸ“¥ Checkout
#         uses: actions/checkout@v4

#       - name: ðŸ³ Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: ðŸ” Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_TOKEN }}

#       - name: ðŸ·ï¸ Extract metadata
#         id: meta
#         run: |
#           SHA=${GITHUB_SHA::7}
#           echo "tag_prefix=main-${SHA}" >> $GITHUB_OUTPUT

#       - name: ðŸ“¦ Build and push evaluation image
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: ./Dockerfile
#           target: evaluation
#           push: true
#           tags: |
#             ${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:${{ steps.meta.outputs.tag_prefix }}-eval
#             ${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:latest-eval
#           cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:buildcache-eval
#           cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:buildcache-eval,mode=max

#   # Job 3: Summary
#   summary:
#     name: ðŸ“Š Build Summary
#     runs-on: self-hosted-local
#     needs: [build-serving, build-evaluation]
#     steps:
#       - name: ðŸ“Š Image summary
#         run: |
#           SHA=${GITHUB_SHA::7}
#           echo "## ðŸ³ Built Images" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "**Serving:** \`${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:main-${SHA}\`" >> $GITHUB_STEP_SUMMARY
#           echo "**Evaluation:** \`${{ secrets.DOCKER_USERNAME }}/demo-app-genai-backend:main-${SHA}-eval\`" >> $GITHUB_STEP_SUMMARY
